name: iPhone 12+ CoreML Converter

on:
  workflow_dispatch:

jobs:
  convert:
    runs-on: macos-14
    steps:
      # ۱. clone repo اصلی
      - uses: actions/checkout@v4

      # ۲. نصب پایتون و ابزارها
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # نصب نسخه های مشخص شده برای جلوگیری از خطا
          pip install "numpy<2.0" "scikit-learn==1.5.1" \
            "coremltools==9.0" torch torchvision diffusers==0.25.1 \
            transformers==4.36.2 huggingface-hub==0.19.4 \
            accelerate==0.32.1 ftfy diffusionkit==0.5.2 \
            sentencepiece wandb pydantic pydantic-core

          git clone https://github.com/apple/ml-stable-diffusion

      # ۳. تبدیل مدل اصلی Stable Diffusion
      - name: Convert SD Model to CoreML
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/ml-stable-diffusion
        run: |
          cd ml-stable-diffusion
          python -m python_coreml_stable_diffusion.torch2coreml \
            --convert-unet \
            --convert-text-encoder \
            --convert-vae-decoder \
            --convert-safety-checker \
            --model-version "runwayml/stable-diffusion-v1-5" \
            --quantize-nbits 6 \
            --chunk-unet \
            --attention-implementation SPLIT_EINSUM \
            -o ../output --bundle-resources-for-swift-cli

      # ۴. اختیاری: تبدیل ControlNet Scribble
      - name: Convert ControlNet (optional)
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          PYTHONPATH: ${{ github.workspace }}/ml-stable-diffusion
        run: |
          cd ml-stable-diffusion
          python -m python_coreml_stable_diffusion.torch2coreml \
            --convert-controlnet \
            --controlnet-model-version "lllyasviel/sd-controlnet-scribble" \
            --model-version "runwayml/stable-diffusion-v1-5" \
            --quantize-nbits 6 \
            -o ../output

      # ۵. آرشیو و آپلود خروجی
      - name: Upload CoreML Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SD-iPhone12Plus-CoreML
          path: ./output
